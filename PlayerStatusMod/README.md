# PlayerStatusMod for Empyrion Galactic Survival

A server-side mod that provides configurable player messaging functionality for Empyrion Galactic Survival dedicated servers. This mod is designed to work in conjunction with [Empyrion Web Helper](https://github.com/chaosz5050/empyrion-web-helper) for complete messaging management.

## Features

- **Welcome Messages**: Customizable messages when players join the server
- **Goodbye Messages**: Customizable messages when players leave the server  
- **Scheduled Messages**: Configurable recurring announcements with custom intervals
- **AFK System**: Players can mark themselves as AFK with custom messages and view who's currently away
- **Real-time Configuration**: Updates configuration without server restart via file monitoring
- **Smart Player Name Resolution**: Handles player name lookup with caching and fallback mechanisms
- **Comprehensive Logging**: Detailed console output for debugging and monitoring

## Integration with Empyrion Web Helper

This mod is part of the **Empyrion Web Helper** ecosystem and is designed to solve message duplication issues that occur with RCON-based messaging:

### Architecture
```
Empyrion Web Helper → JSON Config File → PlayerStatusMod → Native Game API → Players
```

### Benefits of This Integration
- **No Message Duplication**: Uses native Empyrion API instead of RCON
- **Real-time Updates**: Configuration changes from web interface apply immediately
- **Better Reliability**: Native game events are more reliable than RCON
- **Enhanced Player Name Resolution**: Direct access to game player data

### Configuration Management
The mod reads its configuration from `PlayerStatusConfig.json` located in the mod directory. This file is automatically generated and updated by the Empyrion Web Helper web interface, allowing for:

- Easy message template editing via web browser
- Scheduled message configuration with custom intervals
- Enable/disable toggles for different message types
- Real-time configuration updates without server restart

## Installation

### Prerequisites
- Empyrion Galactic Survival dedicated server
- [Empyrion Web Helper](https://github.com/chaosz5050/empyrion-web-helper) (recommended for configuration management)

### Server Installation
1. Download the latest release from the [Releases](https://github.com/chaosz5050/PlayerStatusMod/releases) page
2. Extract the mod files to your server's mod directory:
   ```
   <EmpyrionServer>/Content/Mods/PlayerStatusMod/
   ```
3. Ensure the following files are present:
   - `PlayerStatusMod.dll`
   - `PlayerStatusMod.yaml`
   - `PlayerStatusConfig.json` (created automatically)

### Manual Configuration (Optional)
If not using Empyrion Web Helper, you can manually edit `PlayerStatusConfig.json`:

```json
{
  "welcome_enabled": true,
  "welcome_message": "Welcome to the galaxy, {playername}!",
  "goodbye_enabled": true,
  "goodbye_message": "Player {playername} has left our galaxy",
  "afk_enabled": true,
  "afk_announce_messages": true,
  "afk_auto_timeout_minutes": 15,
  "afk_default_message": "Away from keyboard",
  "afk_list_command_enabled": true,
  "help_command_enabled": true,
  "help_commands": [
    {
      "command": "/vb1",
      "description": "Open virtual backpack 1"
    },
    {
      "command": "/afk [reason]",
      "description": "Mark yourself as AFK with optional reason"
    }
  ],
  "scheduled_messages": [
    {
      "enabled": true,
      "text": "Server backup occurs daily at 3:00 AM",
      "interval_minutes": 60,
      "last_sent": "1970-01-01T00:00:00"
    }
  ]
}
```

## Configuration Options

### Message Templates
- `{playername}` placeholder is replaced with the actual player name
- HTML color codes and formatting are supported
- Messages can be enabled/disabled individually

### Scheduled Messages
- **interval_minutes**: How often the message repeats (in minutes)
- **enabled**: Whether the message is active
- **text**: The message content
- **last_sent**: Timestamp of last send (automatically managed)

### AFK System
- **afk_enabled**: Enable/disable the AFK system
- **afk_announce_messages**: Announce when players go AFK or return
- **afk_auto_timeout_minutes**: Automatic AFK timeout (not yet implemented)
- **afk_default_message**: Default AFK reason if none provided
- **afk_list_command_enabled**: Enable/disable the `/afklist` command

### Help System
- **help_command_enabled**: Enable/disable the `/help` command
- **help_commands**: Array of commands to display in help
  - **command**: The command syntax (e.g., "/vb1", "/afk [reason]")
  - **description**: Brief explanation of what the command does

## Player Commands

### General Commands
- `/help` - Display all available commands with descriptions (private message)

### AFK Commands
- `/afk [reason]` - Mark yourself as AFK with an optional custom reason
- `/back` - Return from AFK status
- `/afklist` - View currently AFK players (private message to requester)

### Virtual Backpack Commands
- `/vb1` to `/vb5` - Open virtual backpacks 1-5 (if available on server)

**Examples:**
```
/help
/afk
/afk taking a break
/afk dinner time
/back
/afklist
/vb1
```

## Development

### Building from Source
```bash
git clone https://github.com/chaosz5050/PlayerStatusMod.git
cd PlayerStatusMod
dotnet build -c Release
```

### Requirements
- .NET Standard 2.0
- Empyrion Modding API (Mif.dll)
- protobuf-net library

### Project Structure
```
PlayerStatusMod/
├── PlayerStatusMod.cs          # Main mod implementation
├── PlayerStatusMod.csproj      # .NET project file
├── PlayerStatusMod.yaml        # Mod metadata
├── References/                 # Empyrion API dependencies
│   ├── Mif.dll
│   └── protobuf-net.dll
└── README.md
```

## Recent Updates

### v1.2.0 - AFK System & Help Command
- **Added**: Complete AFK system with player commands
- **Added**: `/afk [reason]` command to mark yourself as away
- **Added**: `/back` command to return from AFK
- **Added**: `/afklist` command to view currently AFK players
- **Added**: `/help` command showing all available commands
- **Added**: Configurable help system - easily add/modify commands shown
- **Added**: Configurable AFK announcements and settings
- **Enhanced**: Player name resolution for better AFK tracking
- **Enhanced**: Debug logging throughout AFK system

### v1.1.0 - Double Messaging Fix
- **Fixed**: Critical issue where scheduled messages were sent multiple times
- **Added**: Proper state persistence for message timestamps
- **Enhanced**: Debug logging for better troubleshooting
- **Improved**: Error handling for configuration operations

The root cause was missing `SaveConfiguration()` calls after updating message timestamps, causing the mod to re-read old timestamps from disk and send duplicate messages.

## Troubleshooting

### Common Issues

#### Messages Not Appearing
- Check mod is loaded: Look for `[PlayerStatusMod] loaded with configuration support` in server console
- Verify configuration: Ensure `PlayerStatusConfig.json` exists and is valid JSON
- Check message enable flags: Ensure `enabled: true` for relevant messages

#### Duplicate Messages
- Ensure only one instance of PlayerStatusMod is installed
- Verify RCON-based messaging is disabled in other tools
- Check server console for configuration save confirmations

#### Player Names Show as "Unknown Player"
- This is normal during server startup or high load
- The mod includes player name caching and retry mechanisms
- Names should resolve after a short delay

### Debug Information
The mod provides extensive console logging. Look for lines prefixed with `[PlayerStatusMod]` for:
- Configuration loading/saving status
- Message send confirmations
- Player name resolution attempts
- Error messages and diagnostics

## Related Projects

- **[Empyrion Web Helper](https://github.com/chaosz5050/empyrion-web-helper)**: Complete server management web interface
- **[HoverbikeKitMod](https://github.com/chaosz5050/HoverbikeKitMod)**: Player progression rewards mod

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

## Support

For issues related to:
- **Mod functionality**: Open an issue in this repository
- **Web interface integration**: Check the [Empyrion Web Helper](https://github.com/chaosz5050/empyrion-web-helper) repository
- **General Empyrion modding**: Visit the [Empyrion Modding Community](https://empyriononline.com/forums/empyrion-scripting-and-modding.67/)